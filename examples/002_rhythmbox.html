<html>
  <head>
    <meta charset="utf-8"/>
    <title>timbre - oscillators</title>
    <script type="text/javascript" src="../timbre.js"></script>
    <script type="text/javascript" src="js/waveviewer.js"></script>
    <style>
      h1 { margin:0px; }
      header span { font-size:0.8em }
      #waveviewer {
        position:fixed;top:0;left:0;width:100%;height:100%;
      }
      #body {
        position:absolute;top:0;left:0;margin:10px;
      }
      #caution {
        margin:15px 0px;padding:5px;color:red;background:#ffeeee;text-align:center;
        font-size: 1.1em;font-weight:bold;border:solid 1px #ff9999;display:none;
      }
      .prettyprint {
        margin-top:0px;padding:10px !important;background:rgba(255,255,255,0.75);
        font-family: 'Courier New', monospace; font-weight: bold;
      }

      #drumpattern {
        margin:5px;padding:5px;background:#ededed;
        border:solid 1px gray;opacity:0.9;
      }
      #drumpattern label {
        font-size:0.8em;margin-right:10px;font-family:'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <canvas id="waveviewer"></canvas>
    <selction id="body">
      <header style="margin:5px 0px 15px 0px">
        <h1>timbre</h1>
        <span>JavaScript Library for Objective Sound Programming</span><br/>
      </header>
      
      <div id="caution">system requirements: Chrome 14- or Firefox 4-</div>
      
      <button id="play0">play</button><button id="pause0">pause</button>
      <div id="drumpattern"></div>
      <pre id="code" class="prettyprint">
// rhythm box
bpm = 132;
msec = (60 / bpm) * (4 / 16) * 1000;

// seq1
s1 = T("*", s1_t = T("fami", 220, 0, 0.6),
            T("*", T("pulse", 12), s1_env = T("perc", 120)));
s1.freqs = [ 880, 440, 880*2, 220, 880*2, 660, 880*2, 660 ];

// seq2
s2 = T("*", T("saw", s2_t = T("tween", "cubic.out", 300, 880*4, 220), 0, 0.4),
            s2_env = T("adsr", 0, 100, 0.8, 200));
s2_env.onS = function() { s2_env.keyOff(); };

// hihat
hh = T("*", T("HPF", 8000, T("noise")),
            hh_env = T("perc", 30));
// snare drum
sd = T("*", T("rLPF", 5000, 0.4, T("noise")),
            sd_env = T("perc", 120));
// bass drum
bd = T("*", T("rLPF", 40, 0.5, bd_t = T("pulse", 40, 0, 2)),
            bd_env = T("perc", 60));

interval = T("interval", msec, function(i) {
    i %= p[0].length;
    
    if (p[s1.i][i]) {
        s1_t.freq = s1.freqs[i & 7];
        s1_env.bang();
    }
    if (p[s2.i][i]) {
        s2_t.bang();
        s2_env.bang();
    }                 
    if (p[hh.i][i]) {
        hh_env.mul = [0.2, 0.4][i & 1];
        hh_env.bang();
    }
    if (p[sd.i][i]) {
        sd_env.mul = [0.6, 0.4][i & 1];
        sd_env.d   = [180, 120][i & 1];
        sd_env.bang();
    }
    if (p[bd.i][i]) {
        bd_t.bang();
        bd_env.bang();
    }
});

      </pre>

    </section>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/prettify.js"></script>
  <link type="text/css" media="screen" rel="stylesheet" href="css/prettify.css" />
  <script type="text/javascript">
    $(function() {
        if (!timbre._sys._impl) $("#caution").show();    
        prettyPrint();
    
        var viewer = new WaveViewer(timbre._sys, 60, "waveviewer", 512, 256);
        
        timbre.addEventListener("on", function() {
            viewer.start();
        });
        timbre.addEventListener("off", function() {
            viewer.pause();
        });

        var p = [
            [ 1, 1, 1, 1,  1, 1, 1, 1,  1, 1, 1, 1,  1, 1, 1, 1,
              0, 1, 0, 0,  1, 0, 1, 0,  0, 0, 1, 0,  1, 0, 1, 1, ],
            [ 0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,
              1, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0, ],
            [ 1, 0, 0, 0,  1, 0, 1, 0,  1, 0, 1, 0,  1, 0, 0, 0,
              1, 0, 0, 0,  1, 0, 1, 0,  0, 1, 1, 0,  0, 0, 0, 0, ],
            [ 0, 0, 0, 0,  1, 0, 0, 1,  0, 0, 0, 0,  1, 0, 0, 0,
              0, 0, 0, 0,  1, 0, 0, 1,  0, 0, 1, 0,  0, 0, 1, 0, ],
            [ 1, 0, 0, 0,  0, 0, 1, 0,  0, 0, 0, 1,  0, 0, 0, 0,
              1, 0, 0, 0,  0, 0, 1, 0,  0, 1, 0, 0,  1, 0, 0, 0, ],
        ];
        
        (function(elem) {
            var div, x, i, j;
            for (i = 0; i < p.length; i++) {
                div = $(document.createElement("div"));
                div.append($(document.createElement("label")).text(["S1","S2","HH","SD","BD"][i]));
                for (j = 0; j < p[i].length; j++) {
                    x = $(document.createElement("input")).attr("type", "checkbox")
                        .on("click", (function(i, j) {
                            return function() {
                               p[i][j] = $(this).attr("checked") ? 1 : 0;
                            };
                        }(i, j)));
                    if (p[i][j]) x.attr("checked", true);
                    if (j === 15) {
                        x.css("margin-right", "25px");
                    } else if (j % 4 === 3) {
                        x.css("margin-right", "10px");
                    }
                    div.append(x);
                }
                div.appendTo(elem);
            }
        }(document.getElementById("drumpattern")));

        var bpm = 132;
        var msec = (60 / bpm) * (4 / 16) * 1000;
        
        s1 = T("*", s1_t = T("fami", 220, 0, 0.6),
                    T("*", T("pulse", 12), s1_env = T("perc", 120)));
        s1.freqs = [ 880, 440, 880*2, 220, 880*2, 660, 880*2, 660 ];
        s1.i = 0;
        s2 = T("*", T("saw", s2_t = T("tween", "cubic.out", 300, 880*4, 220), 0, 0.4),
                    s2_env = T("adsr", 0, 100, 0.8, 200));
        s2_env.onS = function() { s2_env.keyOff(); };
        s2.i = 1;
        hh = T("*", T("HPF", 8000, T("noise")),
                    hh_env = T("perc", 30));
        hh.i = 2;
        sd = T("*", T("rLPF", 5000, 0.4, T("noise")),
                    sd_env = T("perc", 120));
        sd.i = 3;
        bd = T("*", T("rLPF", 40, 0.5, bd_t = T("pulse", 40, 0, 2)),
                    bd_env = T("perc", 60));
        bd.i = 4;

        dac0 = T("dac", s1, s2, hh, sd, bd);
        
        interval = T("interval", msec, function(i) {
            i %= p[0].length;

            if (p[s1.i][i]) {
                s1_t.freq = s1.freqs[i & 7];
                s1_env.bang();
            }
            if (p[s2.i][i]) {
                s2_t.bang();
                s2_env.bang();
            }                 
            if (p[hh.i][i]) {
                hh_env.mul = [0.2, 0.4][i & 1];
                hh_env.bang();
            }
            if (p[sd.i][i]) {
                sd_env.mul = [0.6, 0.4][i & 1];
                sd_env.d   = [180, 120][i & 1];
                sd_env.bang();
            }
            if (p[bd.i][i]) {
                bd_t.bang();
                bd_env.bang();
            }
        });
        dac0.addEventListener("on", function() {
            interval.on();
        });
        dac0.addEventListener("off", function() {
            interval.off();
        });
        
        var list = [dac0];
        list.forEach(function(dac, i) {
            dac.addEventListener("on" , function() {timbre.on();});
            dac.addEventListener("off", function() {
                if (list.every(function(dac) {return dac.isOff;})) timbre.off();
            });
            $("#play"  + i).on("click", function() { dac.on() ; });
            $("#pause" + i).on("click", function() { dac.off(); });
        });
    });
  </script>
</html>
