<html>
  <head>
    <meta charset="utf-8"/>
    <title>timbre - load wav files and decode</title>
    <link type="text/css" media="screen" rel="stylesheet" href="css/examples.css" />
    <link type="text/css" media="screen" rel="stylesheet" href="css/libs/prettify.css" />
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Comfortaa:700">
    <style>
      #p {
        margin:5px;padding:5px;background:#ededed;
        border:solid 1px gray;opacity:0.9;
      }
      h2 { font-size: 1.1em; }
      #read { display:none; width:80px; }
      #list { display:none; font-family: 'Courier New', monospace; }
      h3 { margin-bottom: 0px; }
      ul { list-style:none; margin:0px; padding:5px; }
      #list pre { margin:0px; font-family: 'Courier New', monospace; }
    </style>
  </head>
  <body>
    <canvas id="waveviewer"></canvas>
    <selction id="body">
      <header style="margin:5px 0px 15px 0px">
        <h1 id="title"><a href="/timbre">timbre</a></h1>
        <span>JavaScript Library for Objective Sound Programming</span><br/>
      </header>
      
      <div id="caution">system requirements: Chrome 14- or Firefox 4-</div>
      
      <button id="play0">play</button><button id="pause0">pause</button>
      <div id="p">
        <h2>You can operate music with your WebConsole. (Chrome Only)</h2>
        <button id="read">read</button>
        <div id="list">
          <h3>Rhythm</h3>
          <ul>
            <li><pre>beat  = [number (0..64)] (default=8)</pre></li>
            <li><pre>piano = [number (0..16)] (default=4)</pre></li>
          </ul>
          <h3>Distortion</h3>
          <ul>
            <li><pre>dist.on() / dist.off()</pre></li>
            <li><pre>dist.pre  = [number] : preGain (default= -30dB)</pre></li>
            <li><pre>dist.post = [number] : postGain(default=  12dB)</li>
            <li><pre>dist.freq = [number] : lpf.freq(default=4800Hz)</li>
            <li><pre>dist.mul  = [number] : volume  (default=0.5)</li>
          </ul>
          <h3>Delay</h3>
          <ul>
            <li><pre>delay.on() / delay.off()</pre></li>
            <li><pre>delay.time = [number] : delayTime(default=125msec)</pre></li>
            <li><pre>delay.fb   = [number] : feedback (default=0.8 )</pre></li>
            <li><pre>delay.wet  = [number] : wet      (default=0.25)</pre></li>
            <li><pre>delay.mul  = [number] : volume   (default=0.5 )</pre></li>
          </ul>
        </div>
      </div>
      <pre id="code" class="prettyprint">
// load wav files and decode

var ex1, timer, amen, pianotones, melo;

timbre.workerpath = "../timbre.js";
timbre.utils.exports("converter"); // use msec2Hz

// dac
ex1 = T("dac");

// timer
timer = T("interval");

// amen (load a wav file and decode it)
amen = T("wav", "./audio/amen.wav", true).load(function(res) {
    timer.interval = this.duration / 192;
});
dist = T("efx.dist", -30, 12, 4800, amen).set("mul", 0.5);
dist.dac = ex1;

(function() {
    var tim = 0, cnt = 0, stay = 0;
    timer.append(function(i) {
        var b = (beat * 3)|0;
        if (b <= 0 || 192 < b || i % (192 / b) !== 0) return;
        if (cnt === 0) {
            if (stay === 0) {
                tim = ((Math.random() * b)|0) * (amen.duration / b);
                amen.currentTime = tim;
                cnt  = (((Math.random() * b) / 24)|0) * 2;
                stay = (((Math.random() * b) /  6)|0);
            } else {
                stay -= 1;
            }
        } else {
            amen.currentTime = tim;
            cnt -= 1;
        }
    });
}());


// piano (load s wav file and decode it)
pianotones = [];
T("wav", "./audio/piano.wav").load(function(res) {
    var i, dx;
    dx = this.duration / 17;
    for (i = 0; i < 17; i++) {
        pianotones[i] = this.slice(dx * i, dx * i + dx);
    }
});

function playpiano(chord, amp) {
    var i, synth = T("+");
    for (i = 0; i < chord.length; i++) {
        synth.append(pianotones[chord[i]].clone());
    }
    synth.mul = amp;
    synth.args[0].addEventListener("~ended", function() {
        synth.dac.remove(synth);
    });
    synth.dac = ex1;
}

(function() {
    var index = 0, prev, chordtable = [
        [5, 9, 16], [7, 11, 16], [5, 9, 16], [4, 7, 12],
    ], amptable = [ 0.9, 0.6, 0.8, 0.6 ];
    timer.append(function(count) {
        var chord, triggr, amp;
        if (0 < piano && piano <= 16) {
            triggr = (64 / piano)|0;
            if (count % triggr === 0) {
                chord = (index / 64)|0;
                if (chord !== prev) {
                    amp = 1.0; prev = chord;
                } else amp = amptable[(index % 16 / 4)|0];
                chord = chordtable[chord];
                playpiano(chord, amp);
            }
        }
        index = (index + 1) % 256;
    });
}());


// melo
var melotone = timbre.utils.wavb( /* define wave-table */ );

melo = T("rLPF", T("pulse", 0.462, 0, 800, 2000, 0.8).kr(),
           0.8, 0.8,
           T("*", T("+", T("osc", melotone, 0, 0, 0.20),
                         T("osc", melotone, 0, 0, 0.15)),
                  T("adsr", 20, 500, 0.4)));
delay = T("efx.delay", 125, 0.8, melo).set("mul", 0.5);
delay.dac = ex1;

(function() {
    var tone1, tone2, env, phrase = [
        0, 0, 0, 0,
        atof("E4"), atof("E4"), atof("A4"),
        atof("A4"), atof("G4"), atof("C5"), ];
    
    tone1 = melo.args[0].args[0].args[0];
    tone2 = melo.args[0].args[0].args[1];
    env   = melo.args[0].args[1];
    
    timer.append(function(count) {
        if (count % 4 !== 0) return;
        
        var freq = phrase[(Math.random() * phrase.length)|0];
        if (freq !== 0) {
            tone1.freq.value = freq;
            tone2.freq.value = freq * 0.996396;
            env.bang();
        }
    });
}());

ex1.onplay  = function() { timer.on() ; };
ex1.onpause = function() { timer.off(); };
ex1.play();
      </pre>
      
    </section>
  </body>
  <script type="text/javascript" src="js/libs/prettify.js"></script>
  <script type="text/javascript">prettyPrint();</script>
  <script type="text/javascript" src="../timbre.js"></script>
  <script type="text/javascript" src="js/003.js"></script>    
  <script type="text/javascript" src="js/waveviewer.js"></script>  
  <script type="text/javascript" src="js/libs/jquery.min.js"></script>
  <script type="text/javascript">
    $(function() {
        if (!timbre.isEnabled) $("#caution").show();
    
        var viewer = new WaveViewer(timbre.sys, 60, "waveviewer", 512, 256);
        
        timbre.addEventListener("on", function() {
            $("#title").css("color", "rgb(0, 136, 0)");
            viewer.start();
        });
        timbre.addEventListener("off", function() {
            $("#title").css("color", "rgb(136, 136, 136)");
            viewer.pause();
        });
        
        var list = [ ex1 ];
        list.forEach(function(ex, i) {
            var dac = ex.dac;
            dac.addEventListener("on" , function() {timbre.on();});
            dac.addEventListener("off", function() {
                if (list.every(function(dac) {return ex.dac.isOff;})) timbre.off();
            });
            $("#play"  + i).on("click", function() { ex.play() ; });
            $("#pause" + i).on("click", function() { ex.pause(); });
        });
    
        if (timbre.env === "webkit") $("#read").show();
        var isOpen = false;
        $("#read").on("click", function() {
            if (isOpen) {
                $(this).text("read");
                $("#list").hide();
            } else {
                $(this).text("close");
                $("#list").show();
            }
            isOpen = !isOpen;
        });
    });
  </script>
</html>
